{% extends "base.html" %}

{% block title %}Onboarding - Commercial Listings{% endblock %}

{% block content %}
<div id="onboarding" class="container py-5">

  <!-- Step 1: Categories -->
  <div v-if="step === 1" class="text-center">
    <h2 class="mb-4">–Ø–∫–∏–π —Ç–∏–ø –ø—Ä–∏–º—ñ—â–µ–Ω–Ω—è –≤–∞—Å —Ü—ñ–∫–∞–≤–∏—Ç—å?</h2>
    <div class="row justify-content-center g-4">
      <div class="col-md-4" v-for="category in categories" :key="category.id">
        <button class="onboarding-option w-100" @click="selectType(category.business_type)">
          [[ category.business_type ]]
        </button>
      </div>
      </div>
    </div>

  <!-- Step 2: Area Selection -->
  <div v-if="step === 2" class="text-center">
    <h2 class="mb-4">–í–∏–±–µ—Ä—ñ—Ç—å –ø–ª–æ—â—É –ø—Ä–∏–º—ñ—â–µ–Ω–Ω—è</h2>
     <div v-if="selectedCategory.business !== '–Ü–Ω—à–µ'" class="area-container">
    <p>–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–∞ –ø–ª–æ—â–∞ –º¬≤</p>
       </div>
    <div class="area-container">
    <div class="area-option">
      <label>–ú—ñ–Ω—ñ–º—É–º:</label>
      <input type="number" v-model.number="area.min" :min="selectedCategory.minArea" :max="selectedCategory.maxArea">
    </div>
    <div class="area-option">
      <label>–ú–∞–∫—Å–∏–º—É–º:</label>
      <input type="number" v-model.number="area.max" :min="area.min" :max="selectedCategory.maxArea">
    </div>
    </div>
    <button class="btn btn-primary mt-3" @click="confirmArea">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏</button>
  </div>


  <!-- STEP 3: Select districts -->
<div v-if="step === 3" class="text-center">
  <h2 class="mb-4">–û–±–µ—Ä—ñ—Ç—å —Ä–∞–π–æ–Ω–∏, —è–∫—ñ –≤–∞—Å —Ü—ñ–∫–∞–≤–ª—è—Ç—å</h2>

   <div class="row justify-content-center g-4">
    <div class="col-md-4" v-for="district in districts" :key="district">
      <button
        class="onboarding-option w-100"
        :class="{ active: selectedDistricts.includes(district) }"
        @click="toggleDistrict(district)"
      >
        üèôÔ∏è <span>[[ district ]]</span>
      </button>
    </div>

    <!-- "Not important" -->
    <div class="col-md-4">
      <button
        class="onboarding-option w-100"
        :class="{ active: notImportant }"
        @click="selectNotImportant"
      >
        ‚ùå <span>–ù–µ–≤–∞–∂–ª–∏–≤–æ</span>
      </button>
    </div>
  </div>

  <button class="onboarding-option confirm-btn mt-4" @click="submitOnboarding">
    ‚úÖ –ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏
  </button>
</div>





</div>
{% endblock %}

{% block scripts %}
<script>
  const categories = {{ categories|tojson }};
</script>
<script>
const { createApp } = Vue;

createApp({
  delimiters: ['[[', ']]'],
  data() {
    return {
      step: 1,
      categories: {{ categories|tojson }},
      selectedCategory: null,
      area: { min: 0, max: 0 },
      districts: {{ districts|tojson }},
      selectedDistricts: [],
      notImportant: false
    };
  },
  methods: {
    async fetchCategories() {
      this.categories = {{ categories|tojson }};
    },
    selectType(type) {
      this.selectedCategory = this.categories.find(c => c.business_type === type);
      if (this.selectedCategory && this.selectedCategory.business !== "–Ü–Ω—à–µ") {
        this.area.min = this.selectedCategory.min_area;
        this.area.max = this.selectedCategory.max_area;
      } else if (this.selectedCategory.business == "–Ü–Ω—à–µ") {
        this.area.min = null;
        this.area.max = null;
      }
      this.step = 2;
    },
    confirmArea() {
      this.step = 3;
    },
    toggleDistrict(district) {
      this.notImportant = false;
      const idx = this.selectedDistricts.indexOf(district);
      if (idx > -1) this.selectedDistricts.splice(idx, 1);
      else this.selectedDistricts.push(district);
    },
    selectNotImportant() {
      this.notImportant = !this.notImportant;
      if (this.notImportant) this.selectedDistricts = [];
    },
    submitOnboarding() {
      const payload = {
        business_type: this.selectedCategory.business_type,
        area: { min: this.area.min, max: this.area.max },
        districts: this.notImportant ? "not_important" : this.selectedDistricts
      };
      console.log("Sending:", payload);
      fetch("/onboarding/offers", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      })
      .then(res => res.json())
      .then(data => console.log("Response from backend:", data))
      .catch(err => console.error("Error:", err));
    }
  },
  mounted() {
    this.fetchCategories().then(() => {
      this.categories.push({
        business_type: "–Ü–Ω—à–µ",
        min_area: null,
        max_area: null
      });
    });
  }
}).mount('#onboarding');
</script>
{% endblock %}
