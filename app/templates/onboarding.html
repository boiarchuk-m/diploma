{% extends "base.html" %}

{% block title %}Onboarding - Commercial Listings{% endblock %}

{% block content %}
<div id="onboarding" class="container py-3">

  <!-- Step 1: Categories -->
  <div v-if="step === 1" class="text-center">
    <h2 class="mb-3">Який тип приміщення вас цікавить?</h2>
    <div class="row justify-content-center g-4">
      <div class="col-md-4" v-for="category in categories" :key="category.id">
        <button class="onboarding-option w-100" @click="selectType(category)">
          [[ category.business_type ]]
        </button>
      </div>
      </div>
    </div>


    <!-- Step 2: City Selection -->
  <div v-if="step === 2" class="text-center">
    <h2 class="mb-4">Виберіть місто</h2>
    <div class="row justify-content-center g-3">
      <div class="col-md-3" v-for="city in cities" :key="city">
        <button
          class="onboarding-option w-100"
          :class="{ active: selectedCity === city }"
          @click="selectCity(city)"
        >
          [[ city ]]
        </button>
      </div>
    </div>

    <div class="mt-3">
      <button class="btn btn-secondary" @click="step = 1"> Назад</button>
    </div>
  </div>




  <!-- Step 3: Area Selection -->
  <div v-if="step === 3" class="text-center">
    <h2 class="mb-4">Виберіть площу приміщення</h2>
     <div v-if="selectedCategory && selectedCategory.business_type !== 'Інше'" class="area-container">
    <p>Рекомендована площа м²</p>
       </div>
    <div class="area-container">
    <div class="area-option">
      <label>Мінімум:</label>
      <input type="number" 
        v-model.number="area.min" 
        :min="selectedCategory ? selectedCategory.min_area : null" 
        :max="selectedCategory ? selectedCategory.max_area : null">
    </div>
    <div class="area-option">
      <label>Максимум:</label>
      <input type="number" 
      v-model.number="area.max" 
      :min="area.min" 
      :max="selectedCategory ? selectedCategory.max_area : null">
    </div>
    </div>
    <div class="mt-3">
      <button class="btn btn-secondary me-2" @click="step = 2"> Назад</button>
      <button class="btn btn-primary" @click="confirmArea">Підтвердити</button>
    </div>
  </div>


  <!-- STEP 4: Select districts -->
<div v-if="step === 4" class="text-center">
  <h2 class="mb-4">Оберіть райони, які вас цікавлять</h2>

   <div class="row justify-content-center g-4">
    <div class="col-md-4" v-for="district in districts" :key="district">
      <button
        class="onboarding-option w-100"
        :class="{ active: selectedDistricts.includes(district) }"
        @click="toggleDistrict(district)"
      >
        <div class="text-center"> <span>[[ district ]]</span> </div>
      </button>
    </div>

    <!-- "Not important" -->
    <div class="col-md-3">
      <button
        class="onboarding-option w-100"
        :class="{ active: notImportant }"
        @click="selectNotImportant"
      >
        <div class="text-center"> <span>Неважливо</span> </div>
      </button>
    </div>
  </div>

   <div class="mt-3">
      <button class="btn btn-secondary me-2" @click="step = 3">Назад</button>
      <button class="onboarding-option confirm-btn mt-4" @click="submitOnboarding">
         Підтвердити
      </button>
    </div>
</div>





</div>
{% endblock %}

{% block scripts %}
<script id ="initial-data" type="application/json">
 {{ {'categories': categories, 'districts': districts, 'cities':cities} |tojson }}
</script> 
 
<script>
const { createApp } = Vue;
const initial = JSON.parse(document.getElementById('initial-data').textContent);

createApp({
  delimiters: ['[[', ']]'],
  data() {
    return {
      step: 1,
      categories: initial.categories || [],
      selectedCategory: null,
      area: { min: null, max: null },
      districts: initial.districts || [],
      cities: initial.cities || [],
      selectedDistricts: [],
      notImportant: false,
      submitting: false,
      errors: []
    };
  },

  watch: {
    // set sensible defaults when user selects a category
    selectedCategory(cat) {
      if (!cat) {
        this.area.min = null;
        this.area.max = null;
        return;
      }
      // backend field names: min_area / max_area
      if (cat.business_type !== 'Інше') {
        this.area.min = cat.min_area ?? this.area.min ?? 0;
        this.area.max = cat.max_area ?? this.area.max ?? this.area.min;
      } else {
        this.area.min = null;
        this.area.max = null;
      }
    }
  },
  methods: {
     selectType(category) {
      this.selectedCategory = category || null;
      this.step = 2;
    },
     selectCity(city) {
      this.selectedCity = city;
      this.step = 3; // go to area selection
    },
    confirmArea() {
      // validate area range when category expects a range
      this.errors = [];
      if (this.selectedCategory && this.selectedCategory.business_type !== 'Інше') {
        if (this.area.min == null || this.area.max == null) {
          this.errors.push('Please set min and max area.');
        } else if (this.area.min > this.area.max) {
          this.errors.push('Min area cannot be greater than max area.');
        }
      }
      if (this.errors.length === 0) this.step = 4;
    },
    toggleDistrict(district) {
      this.notImportant = false;
      const idx = this.selectedDistricts.indexOf(district);
      if (idx > -1) this.selectedDistricts.splice(idx, 1);
      else this.selectedDistricts.push(district);
    },
    selectNotImportant() {
      this.notImportant = !this.notImportant;
      if (this.notImportant) this.selectedDistricts = [];
    },
     async submitOnboarding() {
      if (!this.selectedCategory) {
        this.errors = ['Please choose a category.'];
        return;
      }
      if (!this.selectedCity) {
        this.errors = ['Please choose a city.'];
        return;
      }
      this.submitting = true;
      const payload = {
        business_type_id: this.selectedCategory ? this.selectedCategory.id : null,
        business_type: this.selectedCategory ? this.selectedCategory.business_type : null,
        area: { min: this.area.min, max: this.area.max },
        districts: this.notImportant ? "not_important" : this.selectedDistricts,
        city: this.selectedCity
      };
      try {
       const form = document.createElement('form');
       form.method = 'POST';
        form.action = '/onboarding/offers';
        form.style.display = 'none';
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'payload';
        input.value = JSON.stringify(payload);
        form.appendChild(input);
        document.body.appendChild(form);
        form.submit();
      } catch (err) {
        console.error(err);
        this.errors = ['Failed to submit. Please try again.'];
      } finally {
         this.submitting = false;
      }
    }
  },

  mounted() {
   // ensure "Інше" option exists
    if (!this.categories.some(c => c.business_type === 'Інше')) {
      this.categories.push({ id: null, business_type: 'Інше', min_area: null, max_area: null });
    }
  }
}).mount('#onboarding');
</script>
{% endblock %}
