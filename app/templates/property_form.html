{% extends "base.html" %}

{% block title %}
  {% if offer %}Редагувати оголошення{% else %}Нове оголошення{% endif %}
{% endblock %}

{% block content %}
<div id="app" class="row justify-content-center">
  <div class="col-lg-8">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3>
        {% if offer %}Редагувати оголошення{% else %}Нове оголошення{% endif %}
      </h3>
      <button class="btn btn-outline-secondary btn-sm" onclick="window.history.back()">
        ← Назад
      </button>
    </div>

    <div class="card">
      <div class="card-body">
        <form method="POST" enctype="multipart/form-data">
          <!-- Адреса -->
          <div class="mb-3">
            <label class="form-label">Адреса *</label>
            <input type="text" name="address" class="form-control"
                   value="{{ offer.address if offer else '' }}" required>
          </div>

          <!-- Місто -->
          <div class="mb-3">
            <label class="form-label">Місто</label>
            <input type="text" name="city" class="form-control"
                   value="{{ offer.city if offer else '' }}">
          </div>

          <!-- Район -->
          <div class="mb-3">
            <label class="form-label">Район *</label>
            <input type="text" name="district" class="form-control"
                   value="{{ offer.district if offer else '' }}" required>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Ціна, грн/міс *</label>
              <input type="number" name="price" class="form-control" min="0"
                     value="{{ offer.price if offer else '' }}" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Площа, м² *</label>
              <input type="number" name="area" class="form-control" min="0" step="0.1"
                     value="{{ offer.area if offer else '' }}" required>
            </div>
          </div>

          <!-- Ремонт -->
          <div class="mb-3">
            <label class="form-label">Тип ремонту</label>
            <select name="repair" class="form-select">
              <option value="" {% if not offer or not offer.repair %}selected{% endif %}>Не вказано</option>
              <option value="Косметичний" {% if offer and offer.repair == "Косметичний" %}selected{% endif %}>Косметичний</option>
              <option value="Євроремонт" {% if offer and offer.repair == "Євроремонт" %}selected{% endif %}>Євроремонт</option>
              <option value="Без ремонту" {% if offer and offer.repair == "Без ремонту" %}selected{% endif %}>Без ремонту</option>
            </select>
          </div>

           <!-- Рекомендовано для -->
          <div class="mb-3">
            <label class="form-label">Рекомендовано для (виберіть кілька)</label>
            <select id="recommended-select" multiple>
              <option v-for="bt in businessTypes" :key="bt.id" :value="bt.id" :selected="selectedRecommended.includes(bt.id)">
                [[ bt.business_type ]]
              </option>
            </select>
          </div>

          <!-- Опис -->
          <div class="mb-3">
            <label class="form-label">Опис приміщення</label>
            <textarea name="description" class="form-control" rows="4">{{ offer.description if offer else '' }}</textarea>
          </div>

          <!-- Фото Section with Vue -->
          <div class="mb-3">
            <label class="form-label">Фото приміщення</label>
            <div id="photo-upload">
              <!-- Drop Zone -->
              <div class="drop-zone" @dragover.prevent @drop.prevent="onDrop" @click="$refs.fileInput.click()">
                <p>Перетягніть файли сюди або натисніть, щоб вибрати</p>
                <input ref="fileInput" type="file" multiple accept="image/*" @change="onFileSelect" style="display: none;">
              </div>

              <!-- Selected Files Preview -->
              <div class="previews mt-3">
                <div v-for="(file, index) in selectedFiles" :key="index" class="preview-item">
                  <img :src="file.url" alt="Preview" class="preview-img">
                  <button type="button" class="btn btn-sm btn-danger" @click="removeFile(index)">Видалити</button>
                </div>
              </div>

              <!-- Existing Photos (if editing) -->
              <div v-if="existingPhotos.length" class="mt-3">
                <h6>Наявні фото</h6>
                <div class="previews">
                  <div v-for="(photo, index) in existingPhotos" :key="index" class="preview-item">
                    <img :src="photo.url" alt="Existing" class="preview-img">
                    <input type="radio" name="primary_photo" :value="photo.id" v-model="primaryPhotoId">
                    <span v-if="photo.is_primary" class="badge bg-success">Головне</span>
                    <button type="button" class="btn btn-sm btn-warning" @click="removeExisting(index)">Видалити</button>
                  </div>
                </div>
              </div>
            </div>
          </div>


          <button type="submit" class="btn btn-primary">
            {% if offer %}Зберегти зміни{% else %}Створити оголошення{% endif %}
          </button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script id="initial-data" type="application/json">
  {{ photos_serialized | tojson }}
</script>
<script id="business-types-data" type="application/json">
  {{ business_types | tojson }}
</script>
<script id="current-recommended-data" type="application/json">
  {{ current_recommended | tojson if current_recommended else '[]' }}
</script>
<script>
const { createApp } = Vue;

createApp({
    delimiters: ['[[', ']]'],
  data() {
    return {
      selectedFiles: [],
      existingPhotos: [],
      photosToDelete: [],
      primaryPhotoId: null,
      businessTypes: [],
      selectedRecommended: []
    };
  },
  methods: {
    onFileSelect(event) {
      const files = Array.from(event.target.files);
      this.addFiles(files);
    },
    onDrop(event) {
      const files = Array.from(event.dataTransfer.files);
      this.addFiles(files);
    },
    addFiles(files) {
      files.forEach(file => {
        if (file.type.startsWith('image/') && file.size <= 5 * 1024 * 1024) { // Max 5MB
          const url = URL.createObjectURL(file);
          this.selectedFiles.push({ file, url });
        } else {
          alert('Файл має бути зображенням і не більше 5MB');
        }
      });
    },
    removeFile(index) {
      URL.revokeObjectURL(this.selectedFiles[index].url);
      this.selectedFiles.splice(index, 1);
    },
    removeExisting(index) {
      const photo = this.existingPhotos[index];
      this.markForDeletion(photo.id);
    },
    markForDeletion(photoId) {
      if (!this.photosToDelete.includes(photoId)) {
        this.photosToDelete.push(photoId);
        // Remove from display
        this.existingPhotos = this.existingPhotos.filter(p => p.id !== photoId);
      }
    }

  },
  mounted() {

    try {
      const rawPhotos = document.getElementById('initial-data').textContent || '[]';
      const photosData = JSON.parse(rawPhotos);
      // Compute base URL in JS for safety (avoid inline Jinja)
      const baseUrl = '{{ url_for("static", filename="") }}';
      this.existingPhotos = photosData.map(p => ({
        id: p.id,
        url: baseUrl + p.photo_url.replace(/\\/g, '/').replace(/^\//, ''),
        is_primary: p.is_primary
      }));
      // Set primary photo ID if exists
      const primary = this.existingPhotos.find(p => p.is_primary);
      if (primary) {
        this.primaryPhotoId = primary.id;
      }
    } catch (e) {
      console.error('Failed to parse initial photos:', e);
      this.existingPhotos = [];
    }

    try {
      const btRaw = document.getElementById('business-types-data').textContent || '[]';
      this.businessTypes = JSON.parse(btRaw);
      const recRaw = document.getElementById('current-recommended-data').textContent || '[]';
      this.selectedRecommended = JSON.parse(recRaw);
    } catch (e) {
      console.error('Failed to parse business types or recommendations:', e);
      this.businessTypes = [];
      this.selectedRecommended = [];
    }

    // Sync selectedFiles with the hidden input on form submit
    document.querySelector('form').addEventListener('submit', () => {
       this.selectedFiles.forEach(item => {
        const input = document.createElement('input');
        input.type = 'file';
        input.name = 'photos';
        input.multiple = true;
        input.style.display = 'none';
        const dt = new DataTransfer();
        dt.items.add(item.file);
        input.files = dt.files;
        document.querySelector('form').appendChild(input);
      });  

      // Add deletion inputs
      this.photosToDelete.forEach(delId => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'delete_photos';
        input.value = delId;
        document.querySelector('form').appendChild(input);
      });

      // Add recommended types
      this.selectedRecommended.forEach(typeId => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'recommended_types';
        input.value = typeId;
        document.querySelector('form').appendChild(input);
      });

      // Add primary photo input
      if (this.primaryPhotoId) {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'primary_photo';
        input.value = this.primaryPhotoId;
        document.querySelector('form').appendChild(input);
      }

    });
  }
}).mount('#app');
</script>

<style>
.drop-zone {
  border: 2px dashed #ccc;
  padding: 20px;
  text-align: center;
  cursor: pointer;
  background: #f9f9f9;
  border-radius: 5px;
}
.drop-zone:hover {
  background: #e9e9e9;
}
.previews {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
}
.preview-item {
  position: relative;
  display: inline-block;
}
.preview-img {
  width: 120px;
  height: 90px;
  object-fit: cover;
  border-radius: 5px;
}
.preview-item button {
  position: absolute;
  top: 5px;
  right: 5px;
}
</style>
{% endblock %}